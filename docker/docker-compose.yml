version: '3.8'




# Home Media and Automation Center - Main Docker Compose
# This file orchestrates all services for the home server




services:
  # ================================
  # MQTT Broker - Message Queue
  # ================================
  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"      # MQTT
      - "9001:9001"      # MQTT WebSocket
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - home-network




  # ================================
  # Plex Media Server
  # ================================
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    restart: unless-stopped
    network_mode: host
    environment:
      - PUID=1000
      - PGID=1000
      - VERSION=docker
      - TZ=America/Mexico_City
      # Get your claim token from https://www.plex.tv/claim/
      - PLEX_CLAIM=${PLEX_CLAIM_TOKEN}
    volumes:
      - ./plex/config:/config
      - ./plex/transcode:/transcode
      - /media/movies:/movies
      - /media/tv:/tv
      - /media/music:/music
      - /media/photos:/photos




  # ================================
  # Home Assistant - Home Automation Platform
  # ================================
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    restart: unless-stopped
    network_mode: host
    privileged: true
    environment:
      - TZ=America/Mexico_City
    volumes:
      - ./homeassistant/config:/config
      - /etc/localtime:/etc/localtime:ro
      - /run/dbus:/run/dbus:ro
    depends_on:
      - mosquitto




  # ================================
  # Node-RED - Visual Flow Programming
  # ================================
  nodered:
    image: nodered/node-red:latest
    container_name: nodered
    restart: unless-stopped
    environment:
      - TZ=America/Mexico_City
    ports:
      - "1880:1880"
    volumes:
      - ./nodered/data:/data
    networks:
      - home-network
    depends_on:
      - mosquitto
      - homeassistant




  # ================================
  # Nginx - Reverse Proxy
  # ================================
  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf:/etc/nginx/conf.d
      - ./nginx/ssl:/etc/nginx/ssl
      - ./nginx/logs:/var/log/nginx
      - /etc/letsencrypt:/etc/letsencrypt:ro
    networks:
      - home-network
    depends_on:
      - homeassistant
      - nodered




  # ================================
  # Portainer - Container Management UI
  # ================================
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    ports:
      - "9010:9000"
      - "9443:9443"
    volumes:
      - ./portainer/data:/data
      # The Docker socket mount below is disabled on Windows Docker Desktop by default
      # when enhanced container isolation / socket allow-listing blocks it. If you
      # want Portainer to manage the local Docker Engine, either:
      #  - Add the image name (portainer/portainer-ce:latest) to the Docker Desktop
      #    Docker socket allowed list in the Docker Desktop admin settings, OR
      #  - Use the Portainer agent model (run the agent daemon on the host/WSL) and
      #    connect the server to the agent, OR
      #  - Run Docker on a Linux host/WSL instance where the socket mount is allowed.
      # For now the socket mount is commented out so the rest of the stack can start
      # on Windows without the allow-list error.
      # - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - home-network




  # ================================
  # Prometheus - Metrics Collection
  # ================================
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/config:/etc/prometheus
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
    networks:
      - home-network




  # ================================
  # Grafana - Metrics Visualization
  # ================================
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    networks:
      - home-network
    depends_on:
      - prometheus




  # ================================
  # Node Exporter - System Metrics
  # ================================
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    ports:
      - "9100:9100"
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - home-network




# ================================
# Networks
# ================================
networks:
  home-network:
    driver: bridge




# ================================
# Volumes
# ================================
volumes:
  prometheus-data:
    driver: local
  grafana-data:
    driver: local